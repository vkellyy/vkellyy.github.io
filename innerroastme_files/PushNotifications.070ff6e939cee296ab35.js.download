(window.webpackJsonp=window.webpackJsonp||[]).push([["PushNotifications"],{"./src/graphql/operations/RegisterWebPushToken.json":function(e){e.exports={id:"197650c1946c"}},"./src/lib/timezone/index.ts":function(e,t,n){"use strict";n.d(t,"a",function(){return o}),n.d(t,"b",function(){return a}),n.d(t,"e",function(){return c}),n.d(t,"d",function(){return u}),n.d(t,"f",function(){return d}),n.d(t,"g",function(){return l}),n.d(t,"c",function(){return f});var i=n("./src/lib/constants/index.ts"),r=n("./src/reddit/models/PostCreationForm/index.ts"),s=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(c){r=!0,s=c}finally{try{!i&&a.return&&a.return()}finally{if(r)throw s}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();const o="America/Los_Angeles",a=()=>{let e;try{e=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(t){}return"Asia/Calcutta"===e&&(e="Asia/Kolkata"),e||void 0},c=e=>{const t=Math.abs(e),n=t%60;return`${e>0?"-":"+"}${("0"+Math.floor(t/60)).slice(-2)}:${("0"+n).slice(-2)}`},u=(e,t)=>{const n=t||Date.now(),r={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",timeZoneName:"short",hour12:!1,timeZone:e};let o="";try{o=new Intl.DateTimeFormat("en-US",r).format(new Date(n))}catch(_){return}var a=o.replace(", "," ").split(" "),c=s(a,3);const u=c[0],d=c[1],l=c[2];var f=u.trim().split("/").map(Number),p=s(f,3);const b=p[0],g=p[1],m=p[2];var v=d.trim().split(":").map(Number),j=s(v,3);const O=j[0],h=j[1],w=j[2],k=Date.UTC(m,b-1,g,O,h,w),S=new Date(n).setMilliseconds(0)-k;return{abbreviation:l,offset:Math.round(S/i.mb)}},d=e=>{var t=e.slice(0,19).split("T"),n=s(t,2);const i=n[0],r=n[1];var o=i.split("-").map(Number),a=s(o,3);const c=a[0],u=a[1],d=a[2];var l=r.split(":").map(Number),f=s(l,3);const p=f[0],b=f[1];var g=f[2];return new Date(c,u-1,d,p,b,void 0===g?0:g)},l=e=>{const t=new Date(e);return t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),t.toISOString().slice(0,16)},f=e=>{if(e&&e.eventInfo){var t=e.eventInfo;const n=t.eventStart,s=t.eventEnd;return{startDate:l(new Date(n*i.Yb)),endDate:l(new Date(s*i.Yb)),submitTime:r.i.Now,timezoneName:a()||o}}}},"./src/reddit/actions/notifications/index.ts":function(e,t,n){"use strict";n.r(t);var i=n("./src/app/strings/index.ts"),r=n("./src/config.ts"),s=n("./src/lib/browser/isIncognito.ts"),o=n("./src/lib/constants/index.ts"),a=n("./src/lib/localStorageAvailable/index.ts"),c=n("./src/reddit/actions/notifications/constants.ts"),u=n("./src/reddit/actions/notifications/utils.ts"),d=n("./src/reddit/actions/toaster.ts"),l=n("./src/graphql/operations/RegisterWebPushToken.json"),f=n("./src/lib/makeGqlRequest/index.ts"),p=n("./src/lib/timezone/index.ts");var b=n("./src/reddit/helpers/trackers/notifications.ts"),g=n("./src/reddit/models/Toast/index.ts"),m=n("./src/reddit/selectors/experiments/dnPrePrompt.ts"),v=n("./src/reddit/selectors/notificationPrefs.ts"),j=n("./src/reddit/selectors/user.ts");n.d(t,"getBrowserNotificationPermission",function(){return h}),n.d(t,"resetPermissionRequestClosed",function(){return w}),n.d(t,"isBrowserSubscribedForPushNotifications",function(){return k}),n.d(t,"initializeServiceWorkerChannel",function(){return y}),n.d(t,"requestNotificationsPermissions",function(){return P}),n.d(t,"subscribeForPNs",function(){return N}),n.d(t,"unsubscribeFromPNs",function(){return x});const O=4*o.P,h=()=>{const e=Object(a.a)()&&"1"===localStorage.getItem("notification-permission-request-closed");return"granted"===Notification.permission?c.a.Granted:"denied"===Notification.permission?c.a.Denied:e?c.a.Closed:c.a.Default},w=()=>!!Object(a.a)()&&(localStorage.removeItem("notification-permission-request-closed"),!0),k=async()=>{let e;try{e=await navigator.serviceWorker.register("/sw.js")}catch(t){return!1}return null!==await e.pushManager.getSubscription()},S=e=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({command:"registerClient",v2EventBoilerPlate:b.b(e)})};let _=!1;const y=async e=>{if(_)return;if(_=!0,Object(u.a)(e)!==c.f.NotificationsSupported)return;try{await navigator.serviceWorker.register("/sw.js")}catch(t){return}navigator.serviceWorker.addEventListener("message",t=>{"registerWithServiceWorker"===t.data.command&&S(e)}),S(e)},P=(e,t)=>async(n,i,r)=>{const o=i();if(await Object(s.a)())return;const d=Object(m.a)(o);if(!Object(j.F)(o)&&!d)return;if(await y(o),Object(a.a)()){const t=localStorage.getItem("push-token-last-refresh-ms"),n=(new Date).getTime();if(!e&&t&&parseInt(t)+O>n)return;localStorage.setItem("push-token-last-refresh-ms",n.toString())}b.l(o);const l=Object(u.a)(o);if(l===c.f.BrowserUnsupported)return void b.k(o,"unsupported_browser");if(l===c.f.LocalStorageUnavailable)return void b.k(o,"local_storage_unavailable");if(l===c.f.NotAllRequiredAPIsSupported)return void b.k(o,"not_all_push_apis_supported");if("denied"===Notification.permission)return n(Object(c.p)()),void b.k(o,"already_denied");if("granted"===Notification.permission)return n(Object(c.q)()),void n(N());const f=localStorage.getItem("notification-permission-request-closed");if(!t&&f&&"1"===f)return void b.k(o,"notification_permission_request_closed");const p=localStorage.getItem(c.i);if(t||!p||p!==c.j)if(t||!d||Object(v.c)(o)||(n(Object(c.s)()),!Object(m.c)(d)))switch(n(Object(c.r)()),b.j(o),await Notification.requestPermission()){case"granted":n(Object(c.q)()),n(N()),b.c(o);break;case"denied":n(Object(c.p)()),b.d(o);break;default:n(Object(c.p)()),b.e(o),localStorage.setItem("notification-permission-request-closed","1")}else b.i(i());else b.k(o,"preprompt_closed")},N=e=>async(t,n,s)=>{const o=n();try{const c=await navigator.serviceWorker.register("/sw.js");let u=await c.pushManager.getSubscription();if(!u){const e={userVisibleOnly:!0,applicationServerKey:(e=>{const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),i=new Uint8Array(n.length);for(let r=0;r<n.length;++r)i[r]=n.charCodeAt(r);return i})(r.a.pushNotificationApplicationServerKey)};u=await c.pushManager.subscribe(e)}const m=await((e,t,n)=>{const i={pushToken:JSON.stringify(n),timezoneName:Object(p.b)()||p.a,timestamp:(new Date).toISOString(),language:"en_us"};return Object(f.a)(e,Object.assign({},l,{variables:i}))})(s.gqlContext(),n(),u),v=m.body.data.registerWebPushToken;if(m.ok){if(v&&!v.ok)b.k(o,"registration_failed_in_gql");else if(b.m(o),e){const e=Object(j.P)(n());t(Object(d.e)({kind:g.b.SuccessCommunity,text:Object(i.a)(e,"settings.page.saveRequestSuccess")}))}}else b.k(o,"registration_failed_generally")}catch(a){b.k(o,"registration_failed_uncaught_exception"),console.error(a)}},x=e=>async(t,n,r)=>{try{const r=await navigator.serviceWorker.register("/sw.js"),o=await r.pushManager.getSubscription();if(o&&(o.unsubscribe(),e)){const e=Object(j.P)(n());t(Object(d.e)({kind:g.b.SuccessCommunity,text:Object(i.a)(e,"settings.page.saveRequestSuccess")}))}}catch(s){}}},"./src/reddit/actions/notifications/utils.ts":function(e,t,n){"use strict";n.d(t,"a",function(){return o});var i=n("./src/lib/localStorageAvailable/index.ts"),r=n("./src/reddit/actions/notifications/constants.ts"),s=n("./src/reddit/featureFlags/index.ts");const o=e=>s.d.pushNotificationsBrowserSupported(e)?Object(i.a)()?window.Notification&&window.ServiceWorker&&window.PushManager?r.f.NotificationsSupported:r.f.NotAllRequiredAPIsSupported:r.f.LocalStorageUnavailable:r.f.BrowserUnsupported},"./src/reddit/helpers/trackers/notifications.ts":function(e,t,n){"use strict";n.d(t,"j",function(){return c}),n.d(t,"c",function(){return u}),n.d(t,"d",function(){return d}),n.d(t,"e",function(){return l}),n.d(t,"i",function(){return f}),n.d(t,"g",function(){return p}),n.d(t,"h",function(){return b}),n.d(t,"l",function(){return m}),n.d(t,"m",function(){return v}),n.d(t,"k",function(){return j}),n.d(t,"b",function(){return O}),n.d(t,"a",function(){return _}),n.d(t,"f",function(){return q});var i=n("./src/reddit/models/PushNotification/index.ts"),r=n("./src/reddit/selectors/telemetry.ts"),s=n("./src/telemetry/index.ts");const o=e=>Object.assign({},r.defaults(e),{noun:"desktop_notification_permissions"}),a=e=>Object.assign({},r.defaults(e),{noun:"desktop_notif_preprompt_permissions"}),c=e=>{Object(s.a)(Object.assign({},o(e),{action:"view",source:"popup"}))},u=e=>{Object(s.a)(Object.assign({},o(e),{action:"allow",source:"popup"}))},d=e=>{Object(s.a)(Object.assign({},o(e),{action:"block",source:"popup"}))},l=e=>{Object(s.a)(Object.assign({},o(e),{action:"close",source:"popup"}))},f=e=>{Object(s.a)(Object.assign({},a(e),{action:"view",source:"popup"}))},p=e=>{Object(s.a)(Object.assign({},a(e),{action:"allow",source:"popup"}))},b=e=>{Object(s.a)(Object.assign({},a(e),{action:"close",source:"popup"}))},g=(e,t,n)=>Object.assign({},r.defaults(e),{actionInfo:r.actionInfo(e,{success:t,reason:n}),noun:"desktop_push_token"}),m=e=>{Object(s.a)(Object.assign({},g(e,!0),{action:"request",source:"notifications"}))},v=e=>{Object(s.a)(Object.assign({},g(e,!0),{action:"register",source:"notifications"}))},j=(e,t)=>{Object(s.a)(Object.assign({},g(e,!1,t),{action:"bail",source:"notifications"}))},O=e=>Object.assign({},(e=>Object.assign({},r.defaults(e),{noun:"desktop_push_notification"}))(e),{notification:r.notification(e,void 0,void 0),action:void 0,source:"notifications",correlationId:void 0}),h=e=>(t,n)=>{Object(s.a)(Object.assign({},r.defaults(t),{action:(e=>e?"enable":"disable")(n),noun:e,source:"notifications"}))},w=h("chat_messages"),k=h("chat_requests"),S=h("comment_replies"),_=h("desktop_notification_permissions"),y=h("post_replies"),P=h("private_messages"),N=h("trending_posts"),x=h("username_mention"),q=(e,t,n)=>{switch(t){case i.a.ChatMessages:w(e,n),k(e,n);break;case i.a.TrendingPosts:N(e,n);break;case i.a.UnreadMessages:S(e,n),y(e,n),P(e,n),x(e,n)}}},"./src/reddit/models/PushNotification/index.ts":function(e,t,n){"use strict";var i;n.d(t,"a",function(){return i}),function(e){e.ChatMessages="chatMessages",e.TrendingPosts="trendingPosts",e.UnreadMessages="unreadMessages"}(i||(i={}))},"./src/reddit/selectors/experiments/dnPrePrompt.ts":function(e,t,n){"use strict";n.d(t,"a",function(){return s}),n.d(t,"b",function(){return o}),n.d(t,"c",function(){return a});var i=n("./src/reddit/constants/experiments.ts"),r=n("./src/reddit/helpers/chooseVariant/index.ts");const s=e=>{const t=Object(r.b)(e,{experimentEligibilitySelector:r.a,experimentName:i.l});return Object(i.Y)(t)?void 0:t},o=e=>e===i.k.DarkPrePrompt||e===i.k.DarkSystemDialogue,a=e=>e===i.k.DarkPrePrompt||e===i.k.PrePrompt}}]);
//# sourceMappingURL=PushNotifications.070ff6e939cee296ab35.js.map